defmodule SrpcClient.Connection do
  @moduledoc """
  Documentation for SrpcClient.Connection
  """

  ## =============================================================================================
  ##
  ##  GenServer
  ##
  ## =============================================================================================
  use GenServer

  ## =============================================================================================
  ##
  ##  Client
  ##
  ## =============================================================================================
  ## ---------------------------------------------------------------------------------------------
  ##  Start client
  ## ---------------------------------------------------------------------------------------------
  def start_link({_type, args} = state) do
    case args[:name] do
      nil -> {:error, :invalid_state}
      name -> GenServer.start_link(__MODULE__, state, name: name)
    end
  end

  ## ---------------------------------------------------------------------------------------------
  ##  Init client
  ## ---------------------------------------------------------------------------------------------
  def init({:lib, list} = state) when is_list(list), do: {:ok, state}
  def init({:user, list} = state) when is_list(list), do: {:ok, state}

  ## =============================================================================================
  ##
  ## Public API
  ##
  ## =============================================================================================
  ## ---------------------------------------------------------------------------------------------
  ##  
  ## ---------------------------------------------------------------------------------------------
  def get(path), do: GenServer.call(__MODULE__, {:get, path})

  def debug(path), do: GenServer.call(__MODULE__, {:debug, path})

  ## =============================================================================================
  ##
  ##  GenServer Calls
  ##
  ## =============================================================================================
  ## ---------------------------------------------------------------------------------------------
  ##  
  ## ---------------------------------------------------------------------------------------------
  def handle_call({:get, path}, _from, state), do: {:reply, get(state, path), state}

  def handle_call({:debug, path}, _from, state), do: {:reply, url(state, path), state}

  ## =============================================================================================
  ##
  ##  Private
  ##
  ## =============================================================================================
  ## ---------------------------------------------------------------------------------------------
  ## ---------------------------------------------------------------------------------------------
  defp url(state, path), do: "http://#{state[:host]}:#{state[:port]}/#{path}"

  defp get(state, path) do
    url(state, path) |> HTTPoison.get!()
  end
end
